<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="ElliottX4"><meta name="keywords" content="java"><meta name="description" content="互联网 技术 博客"><link rel="alternative" href="/atom.xml" title="NEVER NEVER NEVER" type="application/atom+xml"><link rel="icon" href="/alipay.png"><title>Java-Threadlocal - NEVER NEVER NEVER</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">NEVER NEVER NEVER</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2019-04-22T07:09:02.000Z">2019 - 04 - 22</time><h1 class="post__title"><a href="/2019/04/22/java-threadlocal的理解/">Java-Threadlocal</a></h1><div class="post__main echo"><h2 id="threadlocal的生命周期和ThreadLocalMap的生命周期"><a href="#threadlocal的生命周期和ThreadLocalMap的生命周期" class="headerlink" title="threadlocal的生命周期和ThreadLocalMap的生命周期"></a>threadlocal的生命周期和ThreadLocalMap的生命周期</h2><ol>
<li><p>ThreadLocal在线程中都创建了有且仅有一个副本ThreadLocal.ThreadLocalMap，每个线程只可以访问自己的ThreadLocalMap实例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void set(T value) &#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);//return t.threadLocals;</span><br><span class="line">    if (map != null)//采用懒汉模式</span><br><span class="line">    	map.set(this, value);</span><br><span class="line">    else</span><br><span class="line">    	createMap(t, value);//t.threadLocals = new ThreadLocalMap(this, firstValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ThreadLocal实例的作用是ThreadLocalMap的key，一个thread可以有多个threadlocal实例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread.currentThread().threadLocals.size //可以查看当前的线程的threadlocal实例数量</span><br></pre></td></tr></table></figure>
</li>
<li><p>ThreadLocalMap实例的生命周期随着线程的结束而结束，因为ThreadLocalMap实例的唯一引用只存在当前线程中。ThreadLocal的生命周期，需要gc来决定，因为他的引用可能存在于多个线程中，此引用为弱引用。</p>
</li>
<li>弱引用的存在，导致可能内存泄露。当threadlocal=null，没有任何强引用实例指向threadLocals中的key本来指向的threadlocal实例，gc回收threadlocal，导致val永远不会被释放。采用以下代码来取代=null的操作。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ThreadLocal local1 = new ThreadLocal();</span><br><span class="line">local.remove();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="ThreadLocal的作用"><a href="#ThreadLocal的作用" class="headerlink" title="ThreadLocal的作用"></a>ThreadLocal的作用</h2><ol>
<li>对于那些需要数据隔离，可以用ThreadLocal。</li>
<li>对于一个线程中的一个ThreadLocal只能存一个T类型的数据。（T为泛型）</li>
<li>ThreadLocal是线程安全的，所以可以用来封装线程不安全的实例，不同线程之间新创建实例，保证线程安全。（另一种模式就是单例模式。）</li>
</ol>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/work/">work</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/java-basic/">java-basic</a></li></ul></footer></article></main><footer class="foot"><div class="foot-copy">&copy; 2018 - 2019 ElliottX4</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>